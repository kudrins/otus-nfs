#
#	Настраиваем сервер nfss
#
sergey@ubuntu1:~/otus/nfs$ vagrant ssh nfss
[vagrant@nfss ~]$ sudo passwd root
Changing password for user root.
New password:
BAD PASSWORD: The password is a palindrome
Retype new password:
passwd: all authentication tokens updated successfully.
[vagrant@nfss ~]$ su root
Password:
#
# устанавливаем утилиты nfs
#
[root@nfss vagrant]# yum install -y nfs-utils
...
Updated:
  nfs-utils.x86_64 1:1.3.0-0.68.el7.2
Complete!
#
# 	включаем firewall и проверяем, что он работает
#
[root@nfss vagrant]# systemctl enable firewalld --now
Created symlink from /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service to /usr/lib/systemd/system/firewall.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/firewalld.service to /usr/lib/systemd/system/firewall.service.

[root@nfss vagrant]# systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2023-12-06 16:32:09 UTC; 9s ago
     Docs: man:firewalld(1)
 Main PID: 3508 (firewalld)
   CGroup: /system.slice/firewalld.service
           └─3508 /usr/bin/python2 -Es /usr/sbin/firewalld --nofork --nopid
...
#
#	разрешаем в firewall доступ к сервисам NFS
#
[root@nfss vagrant]# firewall-cmd --add-service="nfs3" --add-service="rpc-bind"  --add-service="mountd" --permanent
success
[root@nfss vagrant]# firewall-cmd --reload
success
...
#
#	включаем сервер NFS
#
[root@nfss vagrant]# systemctl enable nfs --now
Created symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-serer.service.
#
[root@nfss vagrant]# systemctl status nfs
● nfs-server.service - NFS server and services
   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; enabled; vendor preset: disabled)
  Drop-In: /run/systemd/generator/nfs-server.service.d
           └─order-with-mounts.conf
   Active: active (exited) since Thu 2023-12-07 07:28:32 UTC; 2h 23min ago
...
#	проверяем наличие слушаемых портов nfs
#
[root@nfss vagrant]# ss -ltpnu
Netid State      Recv-Q Send-Q            Local Address:Port                           Peer Address:Port
udp   UNCONN     0      0                             *:20048                                     *:*                  users:(("rpc.mountd",pid=3668,fd=7))
...
udp   UNCONN     0      0                             *:111                                       *:*                  users:(("rpcbind",pid=339,fd=6))
...
udp   UNCONN     0      0                             *:2049                                      *:*
...
udp   UNCONN     0      0                          [::]:20048                                  [::]:*                  users:(("rpc.mountd",pid=3668,fd=9))
udp   UNCONN     0      0                          [::]:111                                    [::]:*                  users:(("rpcbind",pid=339,fd=9))
udp   UNCONN     0      0                          [::]:2049                                   [::]:*
tcp   LISTEN     0      128                           *:111                                       *:*                  users:(("rpcbind",pid=339,fd=8))
tcp   LISTEN     0      128                           *:20048                                     *:*                  users:(("rpc.mountd",pid=3668,fd=8))
...
tcp   LISTEN     0      64                            *:2049                                      *:*
tcp   LISTEN     0      128                        [::]:111                                    [::]:*                  users:(("rpcbind",pid=339,fd=11))
tcp   LISTEN     0      128                        [::]:20048                                  [::]:*                  users:(("rpc.mountd",pid=3668,fd=10))
...
tcp   LISTEN     0      64                         [::]:2049                                   [::]:*

[root@nfss vagrant]# rpcinfo -p localhost | grep nfs
    100003    3   tcp   2049  nfs
    100003    4   tcp   2049  nfs
    100227    3   tcp   2049  nfs_acl
    100003    3   udp   2049  nfs
    100003    4   udp   2049  nfs
    100227    3   udp   2049  nfs_acl
#
#	создаём и настраиваем директорию, которая будет экспортирована
#
[root@nfss vagrant]# mkdir -p /srv/share/upload
[root@nfss vagrant]# chown -R nfsnobody:nfsnobody /srv/share
[root@nfss vagrant]# chmod 777 /srv/share/upload
#
#	создаём в файле /etc/exports структуру, которая позволит экспортировать ранее созданную директорию
#
[root@nfss vagrant]# echo "/srv/share 192.168.50.11/32(rw,sync,root_squash)" > /etc/exports
[root@nfss vagrant]# cat /etc/exports
/srv/share 192.168.50.11/32(rw,sync,root_squash)
#
#	экспортируем ранее созданную директорию
#
[root@nfss vagrant]# exportfs -r
#
#	проверяем
#
[root@nfss vagrant]# exportfs -s
/srv/share  192.168.50.11/32(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,root_squash,no_all_squash)

[root@nfss vagrant]# showmount -a 192.168.50.10
All mount points on 192.168.50.10:
192.168.50.11:/srv/share
#
#	создаем файл
#
[root@nfss vagrant]#touch /srv/share/upload/s1
#
#	после создания на клиенте файла c1, проверяем его наличие
#
[root@nfss vagrant]# ls /srv/share/upload
c1  s1
#
#---------------------------------------------
#
#	Настраиваем клиента nfsc
#
[root@nfsc vagrant]# yum install nfs-utils -y
...
Updated:
  nfs-utils.x86_64 1:1.3.0-0.68.el7.2
Complete!

[root@nfsc vagrant]# systemctl enable firewalld --now
Created symlink from /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service to /usr/lib/systemd/system/firewalld.service.
Created symlink from /etc/systemd/system/multi-user.target.wants/firewalld.service to /usr/lib/systemd/system/firewalld.service.

[root@nfsc vagrant]# echo "192.168.50.10:/srv/share/ /mnt nfs vers=3,proto=udp 0 0" >> /etc/fstab
[root@nfsc vagrant]# cat /etc/fstab
#
# /etc/fstab
...
192.168.50.10:/srv/share/ /mnt nfs vers=3,proto=udp 0 0

[root@nfsc vagrant]# systemctl daemon-reload
[root@nfsc vagrant]# systemctl restart remote-fs.target

[root@nfsc vagrant]# ls /mnt
upload

[root@nfsc vagrant]# reboot

[root@nfsc vagrant]# grep -i "nfs" /boot/config-3.10.0-1127.el7.x86_64 | grep -i udp
#  нет опции CONFIG_NFS_DISABLE_UDP_SUPPORT

[root@nfsc vagrant]# ls /mnt/upload
s1
[root@nfsc vagrant]# touch /mnt/upload/c1
[root@nfsc vagrant]# ls /mnt/upload
c1  s1

[root@nfsc vagrant]# showmount -a 192.168.50.10
All mount points on 192.168.50.10:
192.168.50.11:/srv/share

[root@nfsc vagrant]# mount | grep mnt
192.168.50.10:/srv/share/ on /mnt type nfs (rw,relatime,vers=3,rsize=32768,wsize=32768,namlen=255,hard,proto=udp,timeo=11,retrans=3,sec=sys,mountaddr=192.168.50.10,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=192.168.50.10)
